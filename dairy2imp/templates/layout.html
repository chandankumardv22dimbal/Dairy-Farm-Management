<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dairy Farm Management</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
  <!-- ğŸ§± App Shell (Sidebar + Main) -->
  <div class="app-shell">
    <aside class="sidebar shadow-sm">
      <div class="sidebar-brand d-flex align-items-center px-3 py-3">
        <div class="fs-4">ğŸ„</div>
        <div class="ms-2 fw-bold">Dairy Farm</div>
      </div>

      <nav class="sidebar-nav px-2">
        <a class="nav-link {% if request.endpoint == 'animals' %}active{% endif %}" href="{{ url_for('animals') }}">Animals</a>
        <a class="nav-link {% if request.endpoint == 'milk' %}active{% endif %}" href="{{ url_for('milk') }}">Milk</a>
        <a class="nav-link {% if request.endpoint == 'feed' %}active{% endif %}" href="{{ url_for('feed') }}">Feed</a>
        <a class="nav-link {% if request.endpoint == 'health' %}active{% endif %}" href="{{ url_for('health') }}">Health</a>
        <a class="nav-link {% if request.endpoint == 'employees' %}active{% endif %}" href="{{ url_for('employees') }}">Employees</a>
        <a class="nav-link {% if request.endpoint == 'assignments' %}active{% endif %}" href="{{ url_for('assignments') }}">Assignments</a>
      </nav>

      <div class="sidebar-footer px-3 mt-auto">
        <button id="sidebarToggle" class="btn btn-sm btn-ghost w-100">Toggle</button>
      </div>
    </aside>

    <main class="main-content">
      <div class="container py-4">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-success shadow-sm">
          {% for msg in messages %}
            {{ msg }}<br>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ğŸŸ¢ JS Fallback for Active Nav Highlight + Sidebar Toggle -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const links = document.querySelectorAll(".sidebar-nav .nav-link");
      const currentUrl = window.location.href;

      links.forEach(link => {
        if (link.href === currentUrl) {
          links.forEach(l => l.classList.remove("active"));
          link.classList.add("active");
        }

        link.addEventListener("click", () => {
          links.forEach(l => l.classList.remove("active"));
          link.classList.add("active");
        });
      });

      const toggle = document.getElementById('sidebarToggle');
      const sidebar = document.querySelector('.sidebar');
      if (toggle && sidebar) {
        toggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
        });
      }

      // AJAX page loader: load only the main container from the target page
      async function loadIntoMain(href, push=true) {
        try {
          const res = await fetch(href, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
          if (!res.ok) throw new Error('Network response was not ok');
          const text = await res.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/html');

          // Prefer .container (used in our pages) or fallback to body
          const frag = doc.querySelector('.container') || doc.querySelector('body');
          const target = document.querySelector('.main-content .container');
          if (frag && target) {
            target.innerHTML = frag.innerHTML;
            if (push) history.pushState({url: href}, '', href);
          } else {
            // fallback to full navigation
            window.location.href = href;
          }
        } catch (err) {
          console.error('Failed to load page fragment', err);
          window.location.href = href; // degrade gracefully
        }
      }

      // Attach AJAX behavior to sidebar links
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          // allow ctrl/cmd click and middle click to open in new tab
          if (e.ctrlKey || e.metaKey || e.button === 1) return;
          e.preventDefault();
          links.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          loadIntoMain(link.href);
        });
      });

      // handle browser navigation
      window.addEventListener('popstate', (e) => {
        const url = (e.state && e.state.url) || window.location.href;
        loadIntoMain(url, false);
      });
    });
  </script>
</body>
</html>
